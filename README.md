# Using the Cluster Bootstrap Tools
- [Bootstrapping a New Cluster](#bootstrapping-a-new-cluster)
- [Recreating or Replicating a Cluster](#recreating-a-cluster)
- Creating a Namespace

## Example Workflow & Usage
TBD

## Bootstrapping a New Cluster

This process will generate a set of YAML files that can be used to re-bootstrap a
cluster. Once created, the generated files can be applied to a newly-created cluster
using `kubectl apply -R -f <directory>`. It is recommended to save these YAML files in Git.
In general, they do not contain sensitive information. The one exception to this is 
that they will contain the Git URL, branch, and path that you configure the master Flux
to point to.

### Install Helm
Helm is used to parse the Flux chart in order to create Flux deployment YAMLs. The chart
is not installed directly in order to avoid installing a Tiller that has cluster-wide access.

```bash
mkdir -p tmp/helm
curl -o /tmp/helm/get_helm.sh -L https://git.io/get_helm.sh;
chmod 700 tmp/helm/get_helm.sh
tmp/helm/get_helm.sh [-v <HELM_VERSION>]
rm -rf tmp/helm
```

### Generate YAMLs
1. Clone the 'cluster-bootstrap' repository
2. Change to the `init` directory
3. Execute `bin/gen-bootstrap.sh`

The following arguments can be specified:
- `--flux-version`: the version of Flux to install (defaults to master)
- `--git-branch`: GIT branch containing deployment information (defaults to master)
- `--git-path`: path inside the git repository containing deployment information
- `--git-url`: URL of the git repository containing deployment information
- `--help`: shows this help message

This will create bootstrap YAML files that can be used to deploy the following:
- [Bitnami Sealed Secrets](https://github.com/bitnami-labs/sealed-secrets), with an auto-generated key
- A 'master' [Flux operator](https://github.com/weaveworks/flux) that can be used to deploy namespaces

The Git information (URL, branch, and path) that you specify will be used to configure Flux.
The Flux operator will then monitor that Git location for any changes, and automatically apply any
Kubernetes YAML files it finds. See the Flux documentation for more details.

### Apply the YAML Files
The YAML files generated above can be used to bootstrap a new cluster with the following command:

```bash
kubectl apply -R -f <path/to/bootstrap/yamls>
``` 

These files can be saved in Git, or another suitable location, in case a new copy of the cluster
needs to be created later.

### Authorize Flux to Access Git
Once the bootstrap YAMLs have been applied, wait for the SealedSecrets controller to finish starting.
Then generate a git deploy key with the following script:

1. Clone the 'cluster-bootstrap' repository
2. Change to the `init` directory
3. Execute `bin/init-flux-master-deploy-key.sh`

This will create a directory (`output/keys`) containing the private/public key pair to use as a git
deploy key. It will also create a directory (`output/yaml`) containing the YAML needed to configure
Flux to use this key. For Flux to work, you must upload the public key as a deploy key to your git
server. This key must be given write access. After uploading the key, apply the YAML files to 
configure flux.

You can, but do not need to, save the private key. 

### Save the Sealed Secrets Key
Bitnami Sealed Secrets uses a secret key to encrypt and decrypt secrets used by your cluster. This key is automatically
generated when the Sealed Secrets controller is deployed. However, if you want to be able to create a copy of your cluster
(or recreate the original cluster), the new cluster must be configured with the same key used by the original one. To
be able to do this, we must first save a copy of the original key. The encryption private key can be extracted from the 
cluster with the following command:

```bash
kubectl get secret -n kube-system sealed-secrets-key -o yaml >master.key
```

The created `master.key` file can then be backed up somewhere secure in order to create future clusters.

| ***NOTE***: |
|---|
| ***This key is the controller's public+private key, and should be kept absolutely safe. In particular, do not upload it to Git or another public location.*** |
| |

If you lose this key, or never make a backup of it, you will have to re-encrypt all sealed secrets for your cluster 
using the key generated by the new controller if you need to recreate or replicate your cluster.

## Recreating a Cluster
- Authenticate kubectl: `gcloud container clusters get-credentials <cluster-name>`
- Create new cluster
- Add SealedSecrets key: kubectl apply -f master.key [Sealed Secrets Documentation](https://github.com/bitnami-labs/sealed-secrets)
- Apply bootstrap yaml

## Creating a New Namespace
The following procedure is used to bootstrap a new namespace, which will have its own Flux operator
to manage deployments without affecting other namespaces.

### Bootstrap the Cluster
The cluster you intend to generate a namespace for must have been bootstrapped as discussed above.
Specifically, the Bitnami SealedSecrets controller must be running in the cluster.

### Install OpenSSL
TBD

### Install `kubectl`
TBD

### Install Helm
See instructions under "Bootstrapping a New Cluster", above.

### Install `kubeseal`
- *Windows*: https://github.com/bitnami-labs/sealed-secrets/issues/85
- Linux: TBD

### Generate YAMLs
1. Clone the 'cluster-bootstrap' repository
2. Change to the `init` directory
3. Execute `bin/gen-namespace.sh`

#### Required Arguments
The following arguments must be specified:
- `--namespace`: the name of the Kubernetes namespace to initialize
- `--country`:  the (two-letter) country to use when generating TLS certificates
- `--state`: the (full) state to use when generating TLS certificates
- `--locality`: the city or town name to use when generating TLS certificates
- `--organization`: the organization name to use when generating TLS certificates
- `--git-url`: URL of the git repository containing deployment information
- `--git-path`: path inside the git repository containing deployment information

#### Optional Arguments
The following additional arguments can be specified to customize the new namespace:
- `--flux-version`: the version of Flux to install (defaults to `master`)
- `--git-branch`: git branch containing deployment information (defaults to `master`)
- `--git-path`: path inside the git repository containing deployment information
- `--git-url`: URL of the git repository containing deployment information
- `--helm-domain`: common name for the helm server (defaults to `helm-<namespace`>)
- `--kubeseal-cert`: path to the certificate to use for sealing secrets; if not specified, it will be retrieved from the cluster
- `--tiller-domain`: common name for the tiller server (defaults to `tiller-<namespace>`)

This will create an `output` directory with two sub-directories:
- `tls`: this folder contains the TLS certificate data needed to connect to the namespace Tiller
- `yaml`: this folder contains the YAML files needed to initialize the new namespace

**TLS Folder**

The contents of the TLS folder are only needed if you intend to manually connect to the namespace's
Tiller to perform Helm operations. Flux is automatically configured with the needed certificates. If
you do not intend to manually invoke Helm, you can disregard this folder. If you want to connect to
Helm, save these files somewhere safe. (Do not put them in git, as they contain secret information.)

**YAML Folder**

The contents of the yaml folder will be used by the master Flux to initialize the new namespace. For
this to happen, these files should be checked into git at the path being monitored by the master Flux.
This path will have been set via the `--git-path` argument to the `gen-bootstrap.sh` script executed
above.

Note that once the Flux deployment for the new namespace is completed, the namespace-specific Flux
operator's git deploy key will have to be configured as described in "*Authorize Flux to Access Git*",
above.

### Authorize Namespace Flux to Access Git
After running `bin/gen-namespace.sh` (above), a new directory will be created (`output/keys`). This 
directory contains the private/public key pair to use as a git deploy key. It will also create a 
For Flux to work, you must upload the public key as a deploy key to your git server. This key must 
be given write access.

You can, but do not need to, save the private key. 

## Troubleshooting
TBD